{% extends "base.html" %}
{% block title %}Student: {{ student.voornaam }} {{ student.achternaam }}{% endblock %}
{% block content %}

<h2 class="mb-3">
  {{ student.voornaam }} {{ student.achternaam }}
  <small class="text-secondary">({{ student.studentnummer }})</small>
</h2>

<div class="row g-3">
  <!-- Profile quick info -->
  <div class="col-lg-4">
    <div class="card text-bg-dark border-secondary h-100">
      <div class="card-header">Profiel</div>
      <div class="card-body">
        <dl class="row mb-0">
          <dt class="col-5">Inschrijfdatum</dt>
          <dd class="col-7">{{ student.inschrijfdatum or "—" }}</dd>

          <dt class="col-5">Opleiding</dt>
          <dd class="col-7">
            {% set o = (opleidingen | selectattr('_id','equalto', student.opleiding_id) | list) %}
            {{ (o[0].naam if o and o[0].naam else "—") }}
          </dd>
        </dl>
      </div>
    </div>
  </div>

  <!-- Resultaten -->
  <div class="col-lg-8">
    <div class="card text-bg-dark border-secondary">
      <div class="card-header">Resultaten</div>
      <div class="card-body">
        <form method="post" action="{{ url_for('web.add_result', id=student._id) }}" class="row g-2 mb-3">
          <div class="col-md-4">
            <label class="form-label">OPO</label>
            <select name="opo_id" class="form-select" required>
              {% for o in opos %}
                <option value="{{ o._id }}">{{ o.afkorting }} {{ o.naam }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-3">
            <label class="form-label">Academiejaar</label>
            <select name="academiejaar" class="form-select" required>
              {% for aj in jaren %}
                <option>{{ aj.academiejaar }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Kans</label>
            <select name="kans" class="form-select" required>
              <option value="1">1</option>
              <option value="2">2</option>
            </select>
          </div>
          <div class="col-md-2">
            <label class="form-label">Cijfer</label>
            <input name="cijfer" class="form-control" type="number" step="0.1" min="0" max="20" placeholder="NA=leeg">
          </div>
          <div class="col-md-1 d-flex align-items-end">
            <button class="btn btn-primary w-100">+ </button>
          </div>
        </form>

        <div class="table-responsive">
          <table class="table table-dark table-striped table-hover mb-0 align-middle">
            <thead>
              <tr>
                <th>AJ</th><th>OPO</th><th>Kans</th><th>Cijfer</th><th class="text-end">Acties</th>
              </tr>
            </thead>
            <tbody>
              {% for r in results %}
                <tr>
                  <td>{{ r.academiejaar }}</td>
                  <td>{{ opo_map.get(r.opo_id, r.opo_id) }}</td>
                  <td>{{ r.kans }}</td>
                  <td>{{ "NA" if r.cijfer is none else r.cijfer }}</td>
                  <td class="text-end">
                    <form method="post" action="{{ url_for('web.delete_result', rid=r._id) }}" onsubmit="return confirm('Resultaat verwijderen?')">
                      <button class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
                    </form>
                  </td>
                </tr>
              {% else %}
                <tr><td colspan="5" class="text-center text-secondary">Geen resultaten</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Logs -->
  <div class="col-lg-12">
    <div class="card text-bg-dark border-secondary">
      <div class="card-header">Student-log</div>
      <div class="card-body">
        <form method="post" action="{{ url_for('web.add_log', id=student._id) }}" class="row g-2 mb-3">
          <div class="col-md-3">
            <label class="form-label">Categorie</label>
            <select name="categorie_id" class="form-select">
              <option value="">— (geen)</option>
              {% for c in categories %}
                <option value="{{ c._id }}">{{ c.afkorting }} — {{ c.omschrijving }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="col-md-8">
            <label class="form-label">Beschrijving</label>
            <input name="beschrijving" class="form-control" required>
          </div>
          <div class="col-md-1 d-flex align-items-end">
            <button class="btn btn-primary w-100">+ </button>
          </div>
        </form>

        <div class="table-responsive">
          <table class="table table-dark table-striped table-hover mb-0">
            <thead><tr><th>Datum</th><th>Categorie</th><th>Beschrijving</th><th class="text-end">Acties</th></tr></thead>
            <tbody>
              {% for l in logs %}
                <tr>
                  <td>{{ l.registratiedatum.strftime('%Y-%m-%d %H:%M') if l.registratiedatum else "—" }}</td>
                  <td>
                    {% set cat = (categories | selectattr('_id','equalto', l.categorie_id) | list) %}
                    {{ (cat[0].afkorting if cat else "—") }}
                  </td>
                  <td>{{ l.beschrijving }}</td>
                  <td class="text-end">
                    <form method="post" action="{{ url_for('web.delete_log', lid=l._id) }}" onsubmit="return confirm('Log verwijderen?')">
                      <button class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
                    </form>
                  </td>
                </tr>
              {% else %}
                <tr><td colspan="4" class="text-center text-secondary">Geen logitems</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>
</div>
{% endblock %}
